resources:
- repo: self

trigger:
  batch: true
  branches:
    include:
      - ssharc-v3-whl

jobs:
- job: CredScan
  displayName: "Credential Scan"
  pool:
    name: PowerShell1ES
  steps:
  - task: ms-codeanalysis.vss-microsoft-security-code-analysis-devops.build-task-credscan.CredScan@2
    displayName: 'Run Credential Scanner'
    inputs:
      toolMajorVersion: V2
      suppressionsFile: './scripts/ci/credscan/CredScanSuppressions.json'
  - task: ms-codeanalysis.vss-microsoft-security-code-analysis-devops.build-task-postanalysis.PostAnalysis@1
    displayName: 'Post Analysis'
    inputs:
      AllTools: false
      BinSkim: false
      CredScan: true
      RoslynAnalyzers: false
      TSLint: false
      ToolLogsNotFoundAction: 'Standard'

- job: BuildPackage
  displayName: "Build Package"
  pool:
    name: PowerShell1ES
  steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.8'
    inputs:
      versionSpec: 3.8
  - powershell: |
      Write-Verbose "Cloning az cli" -Verbose
      git clone -q --single-branch -b dev https://github.com/Azure/azure-cli.git ../azure-cli
      python -m venv env
      Write-Verbose "Activate Env" -Verbose
      env\Scripts\activate.ps1
      python -m pip install -U pip
      pip install azdev
      azdev setup -c ../azure-cli -r ./
      azdev --version
      az --version
      azdev extension build ssh
      dir
      Copy-Item -Path ./dist/* -Destination $(Build.ArtifactStagingDirectory) 
      cd $(Build.ArtifactStagingDirectory) 
      dir
  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: drop
  - task: EsrpMalwareScanning@1
    displayName: ESRP Malware Scanning
    inputs:
      ConnectedServiceName: 'pwshScanning'
      FolderPath: '$(Build.ArtifactStagingDirectory)'
      Pattern: '*.whl'
      Region: 'PuertoRico'
      SessionTimeout: '30'
      MaxConcurrency: '50'
      MaxRetryAttempts: '5'